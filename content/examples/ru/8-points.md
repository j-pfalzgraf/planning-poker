# 8 Story Points – Крупные изменения

> **Трудозатраты:** 2–3 дня
> **Риск:** Средний до высокого
> **Тесты:** Требуется комплексный набор тестов
> **Сложность:** Средне-высокая

---

## 📋 Пример 1: Email-уведомления

### Пользовательская история

> Как **новый пользователь** я хочу **получить письмо с подтверждением**, чтобы **верифицировать свой email и активировать аккаунт**.

### Предыстория

После регистрации пользователь должен подтвердить свой email-адрес, прежде чем сможет полноценно использовать приложение. Это повышает безопасность и снижает спам-регистрации.

### Техническая архитектура

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Frontend  │────▶│   Backend   │────▶│   Email     │
│   Register  │     │   API       │     │   Service   │
└─────────────┘     └──────┬──────┘     └──────┬──────┘
                           │                    │
                           ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  Database   │     │   SMTP/SES  │
                    │  (Token)    │     │             │
                    └─────────────┘     └─────────────┘
```

### Шаблон письма

```html
<!-- templates/email/confirm-registration.html -->
<h1>Добро пожаловать в {{appName}}!</h1>
<p>Нажмите кнопку, чтобы подтвердить ваш email:</p>
<a href="{{confirmUrl}}" class="button">Подтвердить Email</a>
<p><small>Ссылка действительна 24 часа.</small></p>
```

### API Endpoints

| Endpoint                        | Метод | Описание                                  |
| ------------------------------- | ----- | ----------------------------------------- |
| `/api/auth/register`            | POST  | Создать пользователя + отправить письмо   |
| `/api/auth/confirm/{token}`     | GET   | Валидировать токен + активировать аккаунт |
| `/api/auth/resend-confirmation` | POST  | Повторно отправить письмо                 |

### Критерии приёмки

- [ ] Создать шаблон письма (HTML + plain text fallback)
- [ ] Токен-ссылка активации со случайной 64-символьной строкой
- [ ] Хранить токен в Redis/DB с TTL 24 часа
- [ ] Страница ошибки для недействительного или просроченного токена
- [ ] Кнопка повторной отправки на странице логина (только если не активирован)
- [ ] Rate limiting: Макс. 3 повторные отправки в час
- [ ] Логирование email для отладки

### Аспекты безопасности

- [ ] Токен криптографически безопасен
- [ ] Токен инвалидируется после использования
- [ ] Защита от brute-force на эндпоинте подтверждения

---

## 📋 Пример 2: Полнотекстовый поиск с подсветкой

### Пользовательская история

> Как **пользователь** я хочу **искать статьи и видеть подсвеченные совпадения**, чтобы **быстро находить релевантную информацию**.

### Техническое решение

```typescript
// Поиск с подсветкой
const searchArticles = async (query: string) => {
  const response = await fetch(`/api/articles/search?q=${encodeURIComponent(query)}`);
  return response.json();
};

// Формат ответа
interface SearchResult {
  id: string;
  title: string;
  titleHighlighted: string;  // С тегами <mark>...</mark>
  excerpt: string;
  excerptHighlighted: string;
  score: number;
}
```

### Критерии приёмки

- [ ] Поле поиска с debounce (300мс между вводами)
- [ ] Поиск в заголовке и описании
- [ ] Подсветка поисковых терминов тегами `<mark>`
- [ ] Минимум 2 символа для поиска
- [ ] Отображение пустого состояния при 0 результатах
- [ ] Кнопка "Загрузить ещё" для > 20 результатов
- [ ] Производительность: < 200мс для 10 000+ статей (требуется индекс)

---

## 📋 Пример 3: Система комментариев

### Пользовательская история

> Как **читатель блога** я хочу **писать комментарии и отвечать другим**, чтобы **участвовать в обсуждении**.

### Модель данных

```typescript
interface Comment {
  id: string;
  postId: string;
  parentId: string | null;  // null = комментарий верхнего уровня
  authorId: string;
  authorName: string;
  content: string;          // макс. 1000 символов
  createdAt: Date;
  updatedAt: Date | null;
  isDeleted: boolean;
}
```

### Структура UI

```
┌─────────────────────────────────────────────────┐
│ 💬 3 комментария                                 │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ 👤 Иван Иванов · 2 часа назад              │ │
│ │ "Отличная статья! Спасибо за советы."      │ │
│ │ [Ответить] [Редактировать] [Удалить]       │ │
│ │                                             │ │
│ │   ┌─────────────────────────────────────┐   │ │
│ │   │ 👤 Мария П. · 1 час назад          │   │ │
│ │   │ "Согласна, очень полезно!"         │   │ │
│ │   │ [Ответить]                          │   │ │
│ │   └─────────────────────────────────────┘   │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### Критерии приёмки

- [ ] Написание комментария (макс. 1000 символов, счётчик символов)
- [ ] Вложенные ответы (1 уровень глубины)
- [ ] Редактирование своих комментариев (с бейджем "изменено")
- [ ] Удаление своих комментариев (soft delete, показывает "[удалено]")
- [ ] Относительные временные метки ("5 минут назад", "вчера")
- [ ] Аватар + имя автора
- [ ] Опционально обновления в реальном времени (WebSocket для живых комментариев)

---

## ✅ Почему 8 баллов?

| Критерий     | Оценка                               |
| ------------ | ------------------------------------ |
| Архитектура  | Интегрировано несколько систем       |
| Сложность    | Frontend + Backend + внешние сервисы |
| Безопасность | Нужно учитывать аспекты безопасности |
| Тесты        | Нужен комплексный набор тестов       |
| Риск         | Повышенный риск из-за зависимостей   |
