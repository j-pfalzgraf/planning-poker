# 8 ストーリーポイント – 大きな変更

> **工数:** 2〜3日
> **リスク:** 中〜高
> **テスト:** 包括的なテストスイートが必要
> **複雑さ:** 中〜高

---

## 📋 例 1: メール通知

### ユーザーストーリー

> **新規ユーザー**として、**確認メールを受け取りたい**。そうすることで、**メールアドレスを確認してアカウントを有効化できます**。

### 背景

登録後、ユーザーはアプリケーションを完全に使用する前にメールアドレスを確認する必要があります。これによりセキュリティが向上し、スパム登録を減らすことができます。

### 技術アーキテクチャ

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ フロントエンド │────▶│  バックエンド  │────▶│   メール    │
│    登録     │     │    API      │     │  サービス   │
└─────────────┘     └──────┬──────┘     └──────┬──────┘
                           │                    │
                           ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │ データベース │     │  SMTP/SES   │
                    │  (トークン)  │     │             │
                    └─────────────┘     └─────────────┘
```

### メールテンプレート

```html
<!-- templates/email/confirm-registration.html -->
<h1>{{appName}}へようこそ！</h1>
<p>ボタンをクリックしてメールを確認してください：</p>
<a href="{{confirmUrl}}" class="button">メールを確認</a>
<p><small>リンクの有効期限は24時間です。</small></p>
```

### APIエンドポイント

| エンドポイント                  | メソッド | 説明                            |
| ------------------------------- | -------- | ------------------------------- |
| `/api/auth/register`            | POST     | ユーザー作成 + メール送信       |
| `/api/auth/confirm/{token}`     | GET      | トークン検証 + アカウント有効化 |
| `/api/auth/resend-confirmation` | POST     | メール再送信                    |

### 受け入れ基準

- [ ] メールテンプレートを作成（HTML + プレーンテキストフォールバック）
- [ ] 64文字のランダム文字列によるトークンベースの有効化リンク
- [ ] Redis/DBに24時間TTLでトークンを保存
- [ ] 無効または期限切れトークンのエラーページ
- [ ] ログインページに再送信ボタン（未有効化の場合のみ）
- [ ] レート制限: 1時間あたり最大3回の再送信
- [ ] デバッグ用のメールログ

### セキュリティ面

- [ ] トークンは暗号的に安全
- [ ] トークンは使用後に無効化
- [ ] 確認エンドポイントへのブルートフォース保護

---

## 📋 例 2: ハイライト付き全文検索

### ユーザーストーリー

> **ユーザー**として、**記事を検索してハイライトされた一致箇所を見たい**。そうすることで、**関連する情報をすばやく見つけることができます**。

### 技術的解決策

```typescript
// ハイライト付き検索
const searchArticles = async (query: string) => {
  const response = await fetch(`/api/articles/search?q=${encodeURIComponent(query)}`);
  return response.json();
};

// レスポンス形式
interface SearchResult {
  id: string;
  title: string;
  titleHighlighted: string;  // <mark>...</mark>タグ付き
  excerpt: string;
  excerptHighlighted: string;
  score: number;
}
```

### 受け入れ基準

- [ ] デバウンス付き検索フィールド（入力間300ms）
- [ ] タイトルと説明で検索
- [ ] `<mark>` タグで検索語をハイライト
- [ ] 検索には最低2文字が必要
- [ ] 結果が0件の場合の空状態表示
- [ ] 20件超の結果には「もっと読み込む」ボタン
- [ ] パフォーマンス: 10,000件以上の記事で200ms未満（インデックスが必要）

---

## 📋 例 3: コメントシステム

### ユーザーストーリー

> **ブログ読者**として、**コメントを書いて他の人に返信したい**。そうすることで、**ディスカッションに参加できます**。

### データモデル

```typescript
interface Comment {
  id: string;
  postId: string;
  parentId: string | null;  // null = トップレベルコメント
  authorId: string;
  authorName: string;
  content: string;          // 最大1000文字
  createdAt: Date;
  updatedAt: Date | null;
  isDeleted: boolean;
}
```

### UI構造

```
┌─────────────────────────────────────────────────┐
│ 💬 コメント3件                                    │
├─────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────┐ │
│ │ 👤 山田太郎 · 2時間前                        │ │
│ │ 「素晴らしい記事です！ヒントをありがとう。」    │ │
│ │ [返信] [編集] [削除]                         │ │
│ │                                             │ │
│ │   ┌─────────────────────────────────────┐   │ │
│ │   │ 👤 鈴木花子 · 1時間前               │   │ │
│ │   │ 「同感です、とても参考になりました！」 │   │ │
│ │   │ [返信]                              │   │ │
│ │   └─────────────────────────────────────┘   │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 受け入れ基準

- [ ] コメントを書く（最大1000文字、文字カウンター）
- [ ] ネストされた返信（1階層まで）
- [ ] 自分のコメントを編集（「編集済み」バッジ付き）
- [ ] 自分のコメントを削除（ソフトデリート、「[削除済み]」と表示）
- [ ] 相対的なタイムスタンプ（「5分前」、「昨日」）
- [ ] アバター + 著者名
- [ ] リアルタイム更新はオプション（ライブコメント用WebSocket）

---

## ✅ なぜ 8 ポイントなのか？

| 基準           | 評価                                         |
| -------------- | -------------------------------------------- |
| アーキテクチャ | 複数システムの統合                           |
| 複雑さ         | フロントエンド + バックエンド + 外部サービス |
| セキュリティ   | 考慮すべきセキュリティ面                     |
| テスト         | 包括的なテストスイートが必要                 |
| リスク         | 依存関係によるリスク増加                     |
