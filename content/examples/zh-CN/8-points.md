# 8 故事点 – 较大变更

> **工作量：** 2-3 天
> **风险：** 中到高
> **测试：** 需要全面的测试套件
> **复杂度：** 中高

---

## 📋 示例 1：邮件通知

### 用户故事

> 作为**新用户**，我希望**收到确认邮件**，以便**我可以验证邮箱地址并激活账户**。

### 背景

注册后，用户必须确认其邮箱地址才能完全使用应用程序。这可以提高安全性并减少垃圾注册。

### 技术架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   前端      │────▶│   后端      │────▶│   邮件      │
│   注册      │     │   API       │     │   服务      │
└─────────────┘     └──────┬──────┘     └──────┬──────┘
                           │                    │
                           ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  数据库     │     │   SMTP/SES  │
                    │  (令牌)     │     │             │
                    └─────────────┘     └─────────────┘
```

### 邮件模板

```html
<!-- templates/email/confirm-registration.html -->
<h1>欢迎使用 {{appName}}！</h1>
<p>点击按钮确认您的邮箱：</p>
<a href="{{confirmUrl}}" class="button">确认邮箱</a>
<p><small>链接有效期 24 小时。</small></p>
```

### API 端点

| 端点                            | 方法 | 描述                |
| ------------------------------- | ---- | ------------------- |
| `/api/auth/register`            | POST | 创建用户 + 发送邮件 |
| `/api/auth/confirm/{token}`     | GET  | 验证令牌 + 激活账户 |
| `/api/auth/resend-confirmation` | POST | 重新发送邮件        |

### 验收标准

- [ ] 创建邮件模板（HTML + 纯文本备用）
- [ ] 基于令牌的激活链接，使用 64 字符随机字符串
- [ ] 将令牌存储在 Redis/数据库中，TTL 为 24 小时
- [ ] 无效或过期令牌的错误页面
- [ ] 登录页面上的重新发送按钮（仅在未激活时显示）
- [ ] 速率限制：每小时最多重新发送 3 次
- [ ] 用于调试的邮件日志

### 安全方面

- [ ] 令牌是加密安全的
- [ ] 令牌使用后失效
- [ ] 确认端点的暴力破解保护

---

## 📋 示例 2：带高亮的全文搜索

### 用户故事

> 作为**用户**，我希望**搜索文章并看到高亮的匹配项**，以便**我可以快速找到相关信息**。

### 技术方案

```typescript
// 带高亮的搜索
const searchArticles = async (query: string) => {
  const response = await fetch(`/api/articles/search?q=${encodeURIComponent(query)}`);
  return response.json();
};

// 响应格式
interface SearchResult {
  id: string;
  title: string;
  titleHighlighted: string;  // 带 <mark>...</mark> 标签
  excerpt: string;
  excerptHighlighted: string;
  score: number;
}
```

### 验收标准

- [ ] 带防抖的搜索框（输入间隔 300ms）
- [ ] 最少 2 个字符后开始搜索
- [ ] 搜索结果中高亮匹配词
- [ ] 显示相关性分数
- [ ] 支持中文分词搜索
